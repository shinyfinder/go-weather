<!DOCTYPE html>
<html>
<head>
	<title>Current Weather searcher</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
	integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
	crossorigin=""/>

	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
	integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
	crossorigin=""></script>


	<style type="text/css">
		table, th, td {
			text-align: center;
			padding-left: 15px;
			padding-right: 15px;
		}
		#mapid {height: 500px;}
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type="text/javascript">
		var current; var wrapped; var lines; var obj;
		$(document).ready(function(){
			// get the date/time
			var d = new Date();
			var min = d.getMinutes();

			// send notice 16 min after to refresh the page
			var timeoutDelay = 16 - min;
			if (timeoutDelay <= 0) {
				timeoutDelay = timeoutDelay + 60;
			}

			
			setTimeout(function() {alert('Weather info updated. Please dismiss this alert and refresh the page to see new weather data.')}, timeoutDelay*60*1000);


			// get the json from github
			$.get("https://raw.githubusercontent.com/shinyfinder/shinybot/weather/weather.json", function(result){
					// assign to gobal var
					obj = result;
					// parse new array as JSON
					obj = JSON.parse(obj);
					console.log(obj);
				});
		});

		function weatherFind() {
			var results = [];
			var toSearch = document.getElementById('weatherSelect').value;
			
			// OW condition codes: Thunderstorm, Drizzle, Rain, Snow, Mist, Smoke, Haze, Dust, Fog, Sand, Dust, Ash, Squall, Tornado, Clear, Clouds (11-25%, 26-50%, 51-84%, 85-100%)

			switch (toSearch) {
				case 'Clear':
				for (var i=0; i<obj.length; i++) {
					if (obj[i].WeatherText == 'Sunny' || obj[i].WeatherText == 'Clear' || obj[i].WeatherText == 'Mostly Sunny' || obj[i].WeatherText == 'Mostly Clear') {
						results.push(obj[i]);
					}
				}
				break;

				case 'Wind':
				for (var i=0; i<obj.length; i++) {
					if (obj[i].WeatherIcon == 32 && obj[i].PrecipitationType === null) {
						//obj[i].weather[0].main = 'Windy';
						results.push(obj[i]);
					}
				}
				break;

				case 'Partly':
				for (var i=0; i<obj.length; i++) {
					if (obj[i].WeatherText == 'Partly Sunny' || obj[i].WeatherText == 'Partly Cloudy' || obj[i].WeatherText == 'Intermittent Clouds' || obj[i].WeatherText == 'Partly Sunny w/ Showers' || obj[i].WeatherText == 'Partly Cloudy w/ Showers' || obj[i].WeatherText == 'Partly Sunny w/ T-Storms' || obj[i].WeatherText == 'Partly Cloudy w/ T-Storms' || obj[i].WeatherText == 'Partly Sunny w/ Flurries') {
						results.push(obj[i]);
					}
				}
				break;

				case 'Clouds':
				for (var i=0; i<obj.length; i++) {
					if (obj[i].WeatherText == 'Mostly Cloudy' || obj[i].WeatherText == 'Cloudy' || obj[i].WeatherText == 'Mostly Cloudy w/ Showers' || obj[i].WeatherText == 'Mostly Cloudy w/ T-Storms' || obj[i].WeatherText == 'Hazy Sunshine' || obj[i].WeatherText == 'Hazy Moonlight' || obj[i].WeatherText == 'Mostly Cloudy w/ Flurries' || obj[i].WeatherText == 'Mostly Cloudy w/ Snow') {
						results.push(obj[i]);
					}
				}

				break;

				case 'Rain':
				for (var i=0; i<obj.length;i++) {
					if(obj[i].WeatherText == 'Showers' || obj[i].WeatherText == 'Rain' || obj[i].WeatherText == 'T-Storms') {
						results.push(obj[i]);
					}
				}
				break;

				case 'Fog':
				for (var i=0; i<obj.length;i++) {
					if(obj[i].WeatherText == 'Fog') {
						results.push(obj[i]);
					}
				}
				break;

				case 'Snow':
				for (var i=0; i<obj.length;i++) {
					if (obj[i].WeatherText == 'Snow' || obj[i].WeatherText == 'Flurries' || obj[i].WeatherText == 'Rain and Snow') {
						results.push(obj[i]);
					}
				}				


				default:
				for (var i=0; i<obj.length; i++) {
					if(obj[i].WeatherText.indexOf(toSearch)!=-1) {
						results.push(obj[i]);
					}
				}

			}

				// push the names and locations into separate arrays
				console.log(results);
				var loc = []; var lon = []; var lat = [];
				if (results.length > 10) {
					var loopEnd = 10;
				} else {
					var loopEnd = results.length;
				}

				for (var i=0; i<loopEnd; i++) {
					loc.push(results[i].EnglishName);
					lon.push(results[i].GeoPosition.Longitude);
					lat.push(results[i].GeoPosition.Latitude);
				}
				loc = loc.join('<br />');
				lon = lon.join('<br />');
				lat = lat.join('<br />');

				document.getElementById('cityOut').innerHTML = loc;
				document.getElementById('latOut').innerHTML = lat;
				document.getElementById('lonOut').innerHTML = lon;
			}
		</script>


	</head>
	<body>
		<label for='weatherSelect'>Choose a weather condition:</label>
		<select name='weatherSelect' id='weatherSelect'>
			<option value='Clear'>Clear</option>
			<option value='Rain'>Rainy</option>
			<option value='Partly'>Partly Cloudy</option>
			<option value='Clouds'>Cloudy</option>
			<option value='Wind'>Windy</option>
			<option value='Snow'>Snow</option>
			<option value='Fog'>Fog</option>
		</select>
		<button id="json" onclick="weatherFind()">Find the weather!</button>

		<table>
			<tr>
				<th>City</th>
				<th>Latitude</th>
				<th>Longitude</th>
			</tr>
			<tr>
				<td id='cityOut'></td>
				<td id='latOut'></td>
				<td id='lonOut'></td>
			</tr>
		</table>
		<div id="mapid"></div>


				<script type="text/javascript">
			var mymap = L.map('mapid').setView([51.505,-0.03],3);

			L.tileLayer('https://openweathermap.org/weathermap?basemap=map&cities=false&layer=windspeed&lat=30&lon=-20&zoom=3', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				maxZoom: 18,
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1,
				accessToken: 'your.mapbox.access.token'
			}).addTo(mymap);
		</script>
	</body>
	</html>